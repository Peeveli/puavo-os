#!/bin/sh

PREREQ=""

prereqs()
{
        echo "${PREREQ}"
}

case ${1} in
        prereqs)
                prereqs
                exit 0
                ;;
esac

for x in $(cat /proc/cmdline); do
  case "$x" in
    puavo.abitti.boot=true)
      # bind kernel module directory to system
      mkdir -p /image /root/lib/modules
      mount -r -o loop /root/lib/live/mount/medium/ltsp.img /image
      mount --bind /image/lib/modules /root/lib/modules

      # Setup persistent storage filesystem as a loopback device.
      # This filesystem needs to be on a read-write mount so that
      # our loopback filesystem can also be read-write (thus the above
      # "/root/lib/live/mount/medium" will not do).
      mkdir -p /state
      mount /dev/mapper/puavo-state /state
      losetup -f /state/abitti/persistent_abitti_fs
      umount -l /state
      ;;
  esac
done
