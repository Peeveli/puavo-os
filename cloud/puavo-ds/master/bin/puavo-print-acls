#!/usr/bin/env tclsh

#
# GLOBAL VARIABLES
#

# XXX these should come from somewhere
set ldapsuffix [lindex $argv 0]
set samba_domain [lindex $argv 1]

if {[llength $argv] != 2 || $ldapsuffix eq "" || $samba_domain eq ""} {
  puts stderr "usage: puavo-print-acl ldapsuffix samba_domain"
  exit 1
}

set rules [list]

#
# SUBROUTINES
#

proc attrs {args} {
  format {attrs="%s"} [join $args ","]
}

proc dn {scope {_branch ""}} {
  global ldapsuffix
  set branch [expr { $_branch ne "" ? "${_branch}," : ""}]
  format {dn.%s="%s%s"} $scope $branch $ldapsuffix
}

proc systemgroup {groupname} {
  global ldapsuffix
  format {group/puavoSystemGroup/member="cn=%s,ou=System Groups,%s"} \
         $groupname $ldapsuffix
}

# XXX why sometimes exact, sometimes not?
proc puavo_dn {name} {
  format {dn="uid=%s,o=puavo"} $name
}
proc puavo_dn_exact {name} {
  format {dn.exact="uid=%s,o=puavo"} $name
}

proc rule {rulelines} {
  global rules
  set subst_rulelines [uplevel 1 [list subst $rulelines]]
  set rule_elems [split $subst_rulelines]
  set nonempty_rule_elems [lmap _ $rule_elems { expr { $_ ne "" ? $_ : [continue] } }]
  lappend rules [join $nonempty_rule_elems " "]
}

proc ldapset_with_base {setspec} {
  global ldapsuffix
  format {set="[%s]/%s"} $ldapsuffix $setspec
}

proc ldapset {setspec} {
  format {set="%s"} $setspec
}

proc devicetype_set {devtype} {
  ldapset [format {user/puavoDeviceType & [%s]} $devtype]
}

proc person_affiliation_set {affliation} {
  ldapset [format {user/puavoEduPersonAffiliation & [%s]} $affliation]
}

proc puavoversion_set {version} {
  ldapset_with_base [format {puavoVersion & [%d]} $version]
}

#
# some constants
#

set Applications    "ou=Applications,ou=Desktops"
set Bookmarks       "ou=Bookmarks,ou=Desktops"
set Classes         "ou=Classes,ou=Groups"
set Desktops        "ou=Desktops"
set Devices         "ou=Devices,ou=Hosts"
set Domain_Admins   "cn=Domain Admins,ou=Groups"
set Domain_Users    "cn=Domain Users,ou=Groups"
set Files           "ou=Files,ou=Desktops"
set Firefox         "ou=Firefox,ou=Desktops"
set Groups          "ou=Groups"
set Hosts           "ou=Hosts"
set People          "ou=People"
set Printers        "ou=Printers"
set Roles           "ou=Roles"
set RolesGroups     "ou=Roles,ou=Groups"
set Schools         "ou=Schools,ou=Groups"
set SchoolRoles     "ou=SchoolRoles,ou=Groups"
set Servers         "ou=Servers,ou=Hosts"
set Services        "ou=Services,ou=Desktops"
set System_Accounts "ou=System Accounts"
set System_Groups   "ou=System Groups"

set org_owner "group/puavoEduOrg/owner=${ldapsuffix}"

set ownerusers         [ldapset_with_base "owner* & user"]        ; # XXX what does this mean?
set schooladmins       [ldapset "user/puavoAdminOfSchool*"]
set schooladmins_or_ownerusers [ldapset [format {this/puavoSchoolAdmin* | [%s]/owner* & user} $ldapsuffix]]
set schooladminusers   [ldapset "this/puavoSchoolAdmin* & user"]
set teachers           [person_affiliation_set teacher]
set this_school_admins [ldapset "this/puavoSchool & user/puavoAdminOfSchool*"]

#
# RULES
#

# XXX why is this needed?
rule {
  [dn onelevel ou=Groups] filter="(objectClass=posixGroup)"
    by [puavoversion_set 2] none stop
    by *                    none break
}

# XXX why are these needed?
foreach branch {Schools Roles SchoolRoles Classes} {
  rule {
    [dn subtree ou=$branch,ou=Groups]
      by [puavoversion_set 2] none break
  }
}

# XXX why is this needed?
rule {
  [dn subtree ou=Samba,ou=Hosts]
    by [dn children $Servers] write
    by *                      none break
}

# XXX why is this needed?
rule {
  [dn subtree $People]
    [attrs sambaNTPassword userPassword sambaAcctFlags]
      by [dn children $Servers] write
      by *                      none break
}

# XXX why is this needed?
rule {
  [dn exact sambaDomainName=${samba_domain}]
      by [dn children $Servers] write
      by *                      none break
}

# XXX why is this needed?
rule {
  [dn exact ou=Idmap]
      by [dn children $Servers] write
      by *                      none break
}

# XXX why is this needed?
# XXX comments inside rules might be useful
rule {
  [dn exact $Printers]
    [attrs ou entry objectClass]
      by [dn children $Servers]      read
      by [puavo_dn_exact slave]      read
      by $ownerusers                 read
      by [dn children $People]       read
      by [systemgroup printerqueues] read
}

rule {
  [dn exact $Printers] [attrs children]
      by $ownerusers                 write
      by [dn children $Servers]      write
      by [dn children $People]       read
      by [puavo_dn_exact slave]      read
      by [systemgroup printerqueues] read
}

rule {
  [dn children $Printers]
      by $ownerusers                 write
      by [dn children $Servers]      write
      by [dn children $People]       read
      by [puavo_dn_exact slave]      read
      by [systemgroup printerqueues] read
}

rule {
  [dn children $Servers]
     [attrs puavoDeviceCurrentImage puavoDeviceAvailableImage]
       by $org_owner              write
       by $this_school_admins     write
       by self                    write
       by [puavo_dn monitor]      read
       by [puavo_dn puavo-ticket] read
       by [devicetype_set laptop] read
       by [systemgroup devices]   read
}

rule {
  [dn children $Devices]
    [attrs puavoDeviceHWInfo]
      by [dn children $Servers]  write
      by self                    write
      by $org_owner              read
      by $this_school_admins     read
      by [puavo_dn monitor]      read
      by [puavo_dn puavo-ticket] read
      by [systemgroup devices]   read
}

rule {
  [dn subtree]
      by [dn children $Servers] read
      by [puavo_dn_exact slave] read
      by *                      none break
}

rule {
  [dn exact $People]
    [attrs entry ou objectClass]
      by [dn children $People]   read
      by [dn subtree  $Hosts]    read
      by [systemgroup getent]    read
      by [systemgroup auth]      read
      by [puavo_dn pw-mgmt]      read
      by [puavo_dn puavo-ticket] read
      by [puavo_dn_exact puavo]  read
      by anonymous               auth
}

rule {
  [dn exact $People]
    [attrs children]
      by $schooladmins          write
      by $ownerusers            write
      by [puavo_dn_exact puavo] read
}

rule {
  [dn subtree $People]
    [attrs puavoAdminOfSchool]
      by $ownerusers write
      by users       read
}

rule {
  [dn subtree $People]
    [attrs userPassword]
    filter="(puavoEduPersonAffiliation=student)"
      by $schooladmins  =azx
      by $ownerusers    =azx
      by $teachers      =azx
      by *              none break
}

rule {
  [dn subtree $People]
    [attrs userPassword]
    filter="(puavoLocked=TRUE)"
      by $org_owner          =azx
      by $this_school_admins =azx
      by self                =azx
}

rule {
  [dn subtree $People]
    [attrs userPassword]
      by $org_owner          =azx
      by $this_school_admins =azx
      by [puavo_dn pw-mgmt]  =azx
      by self                =azx
      by anonymous           auth
}

rule {
  [dn subtree $People]
    [attrs sambaPwdLastSet shadowLastChange]
    filter="(puavoEduPersonAffiliation=student)"
      by $schooladmins  write
      by $ownerusers    write
      by $teachers      write
      by *              none break
}

rule {
  [dn subtree $People]
    [attrs sambaPwdLastSet shadowLastChange]
      by $org_owner          write
      by $this_school_admins write
      by self                write
      by anonymous           auth
}

rule {
  [dn subtree $People]
    [attrs entry uid puavoId eduPersonPrincipalName objectClass \
           puavoEduPersonAffiliation puavoRemovalRequestTime]
      by $org_owner              write
      by $this_school_admins     write
      by [puavo_dn pw-mgmt]      read
      by [puavo_dn puavo]        read
      by [puavo_dn puavo-ticket] read
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
      by [systemgroup auth]      read
      by anonymous               auth
}

rule {
  [dn subtree $People]
    [attrs uidNumber gidNumber homeDirectory givenName sn \
           puavoPreferredDesktop loginShell]
      by $org_owner              write
      by $this_school_admins     write
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
      by [puavo_dn pw-mgmt]      read
      by [puavo_dn puavo]        read
      by [puavo_dn puavo-ticket] read
}

rule {
  [dn subtree $People]
    [attrs puavoExternalId]
      by $org_owner                write
      by $this_school_admins       write
      by self                      read
      by $schooladmins             read
      by $ownerusers               read
      by $teachers                 read
      by [systemgroup addressbook] read
}

rule {
  [dn subtree $People]
    [attrs givenName sn displayName puavoEduPersonReverseDisplayName]
      by $org_owner                write
      by $this_school_admins       write
      by [dn children $People]     read
      by [dn subtree $Hosts]       read
      by [systemgroup getent]      read
      by [systemgroup addressbook] read
      by [puavo_dn puavo-ticket]   read
}

rule {
  [dn subtree $People]
    [attrs puavoEduPersonPersonnelNumber]
      by $org_owner                write
      by $this_school_admins       write
      by [systemgroup addressbook] read
      by [puavo_dn puavo-ticket]   read
}

rule {
  [dn subtree $People]
    [attrs jpegPhoto mail preferredLanguage puavoLocale telephoneNumber]
      by $org_owner                write
      by $this_school_admins       write
      by self                      write
      by [systemgroup addressbook] read
      by [puavo_dn pw-mgmt]        read
      by [puavo_dn_exact puavo]    read
      by [puavo_dn puavo-ticket]   read
}

rule {
  [dn subtree $People]
    [attrs puavoAcceptedTerms]
      by $org_owner              write
      by $this_school_admins     write
      by [puavo_dn_exact puavo]  read
      by [puavo_dn puavo-ticket] read
      by self                    write
}

rule {
  [dn subtree $People]
    [attrs puavoSchool puavoLocked]
      by $org_owner              write
      by $this_school_admins     write
      by self                    read
      by [puavo_dn_exact puavo]  read
      by [puavo_dn puavo-ticket] read
      by [systemgroup getent]    read
}

rule {
  [dn subtree $People]
    [attrs sambaNTPassword sambaLMPassword]
      by $org_owner          =az
      by $this_school_admins =az
}

rule {
  [dn subtree $People]
      by $org_owner
      write by $this_school_admins
      write by [dn subtree $Hosts]
      read
}

rule {
  [dn exact $Roles]
    [attrs entry ou objectClass]
      by $schooladmins read
      by $ownerusers   read
}


rule {
  [dn exact $Roles]
    [attrs children]
      by $schooladmins write
      by $ownerusers   write
}

rule {
  [dn children $Roles]
      by $org_owner          write
      by $this_school_admins write
}

rule {
  [dn subtree "ou=Kerberos Realms"]
      by [puavo_dn kadmin] write
      by [puavo_dn kdc]    read
}

rule {
  [dn exact $Hosts]
      by $schooladmins           read
      by $ownerusers             read
      by [puavo_dn puppet]       read
      by [puavo_dn monitor]      read
      by [puavo_dn puavo-ticket] read
      by [dn subtree $Hosts]     read
      by [systemgroup devices]   read
      by [systemgroup servers]   read
      by [dn children $People]   read
}

rule {
  [dn exact $Devices]
    [attrs entry ou objectClass]
      by $schooladmins           read
      by $ownerusers             read
      by [puavo_dn puppet]       read
      by [puavo_dn monitor]      read
      by [puavo_dn puavo-ticket] read
      by [systemgroup devices]   read
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by anonymous               auth
}

rule {
  [dn exact $Devices]
    [attrs children]
      by $schooladmins           write
      by $ownerusers             write
      by [puavo_dn puppet]       read
      by [puavo_dn monitor]      read
      by [puavo_dn puavo-ticket] read
      by [systemgroup devices]   read
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
}

rule {
  [dn children $Devices]
    [attrs entry objectClass puavoWlanChannel puavoHostname puavoTag]
      by $org_owner              write
      by $this_school_admins     write
      by [puavo_dn puppet]       read
      by [puavo_dn monitor]      read
      by [puavo_dn puavo-ticket] read
      by [systemgroup devices]   read
      by [dn children $People]   read
      by self                    read
      by anonymous               auth
}

rule {
  [dn children $Devices]
    [attrs userPassword]
      by $org_owner          write
      by $this_school_admins write
      by anonymous           auth
}

rule {
  [dn children $Devices]
    [attrs puavoDeviceCurrentImage puavoDeviceMonitorsXML \
           puavoDevicePrimaryUser puavoDeviceAvailableImage]
      by $org_owner              write
      by $this_school_admins     write
      by self                    write
      by [puavo_dn monitor]      read
      by [puavo_dn puavo-ticket] read
      by [systemgroup devices]   read
}

rule {
  [dn children $Devices]
      by $org_owner              write
      by $this_school_admins     write
      by [puavo_dn puppet]       read
      by [puavo_dn monitor]      read
      by [puavo_dn puavo-ticket] read
      by [systemgroup devices]   read
      by self                    read
      by anonymous               auth
}

rule {
  [dn exact $Servers]
    [attrs entry ou objectClass]
      by $ownerusers             read
      by [puavo_dn puppet]       read
      by [puavo_dn monitor]      read
      by [puavo_dn puavo-ticket] read
      by $schooladmins           read
      by [systemgroup servers]   read
      by anonymous               auth
}

rule {
  [dn exact $Servers]
    [attrs children]
      by $ownerusers             write
      by [puavo_dn puppet]       read
      by [puavo_dn monitor]      read
      by [puavo_dn puavo-ticket] read
      by [systemgroup servers]   read
}

rule {
  [dn children $Servers]
      by $ownerusers             write
      by [puavo_dn puppet]       read
      by [puavo_dn monitor]      read
      by [puavo_dn puavo-ticket] read
      by [systemgroup servers]   read
      by [devicetype_set laptop] none break
      by $this_school_admins     none break
      by anonymous               auth
}

rule {
  [dn children $Servers]
    [attrs entry puavoId puavoSchool ou objectClass puavoExport puavoHostname]
      by [devicetype_set laptop] read
      by $this_school_admins     read
}

rule {
  [dn exact ou=Samba,ou=Hosts]
    [attrs entry ou objectClass]
      by [dn children $Servers] read
}

rule {
  [dn exact ou=Samba,ou=Hosts]
    [attrs children]
      by [dn children $Servers] write
}

rule {
  [dn children ou=Samba,ou=Hosts]
      by [dn children $Servers] write
}

rule {
  [dn exact $Domain_Admins]
    [attrs memberUid]
      by $ownerusers write
}

rule {
  [dn exact $Domain_Users]
    [attrs memberUid]
      by $schooladmins write
      by $ownerusers   write
}

rule {
  [dn exact $Domain_Admins]
    by $ownerusers read
}

rule {
  [dn exact $Domain_Users]
    by $schooladmins read
    by $ownerusers   read
}

rule {
  [dn exact $Groups]
    [attrs entry ou objectClass]
      by $schooladmins           read
      by $ownerusers             read
      by [puavo_dn puavo-ticket] read
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
}

rule {
  [dn exact $Groups]
    [attrs children]
      by $schooladmins           write
      by $ownerusers             write
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
      by [puavo_dn puavo-ticket] read
}

rule {
  [dn exact $Schools]
    [attrs entry ou objectClass]
      by $schooladmins           read
      by $ownerusers             read
      by [puavo_dn puavo-ticket] read
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
}

rule {
  [dn exact $Schools]
    [attrs children]
      by $schooladmins           write
      by $ownerusers             write
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
      by [puavo_dn puavo-ticket] read
}

rule {
  [dn subtree $Schools]
      by $ownerusers             write
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
      by [puavo_dn puavo-ticket] read
}

rule {
  [dn exact $RolesGroups]
    [attrs entry ou objectClass]
      by $schooladmins           read
      by $ownerusers             read
      by [puavo_dn puavo-ticket] read
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
}

rule {
  [dn exact $RolesGroups]
    [attrs children]
      by $schooladmins           write
      by $ownerusers             write
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
      by [puavo_dn puavo-ticket] read
}

rule {
  [dn subtree $RolesGroups]
    [attrs member memberUid]
      by $org_owner              write
      by $this_school_admins     write
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
      by [puavo_dn puavo-ticket] read
}

rule {
  [dn subtree $RolesGroups]
      by $ownerusers             write
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
      by [puavo_dn puavo-ticket] read
}

rule {
  [dn exact $SchoolRoles]
    [attrs entry ou objectClass]
      by $schooladmins           read
      by $ownerusers             read
      by [puavo_dn puavo-ticket] read
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
}

rule {
  [dn exact $SchoolRoles]
    [attrs children]
      by $schooladmins           write
      by $ownerusers             write
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
      by [puavo_dn puavo-ticket] read
}

rule {
  [dn subtree $SchoolRoles]
    [attrs member memberUid]
      by $org_owner              write
      by $this_school_admins     write
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
      by [puavo_dn puavo-ticket] read
}

rule {
  [dn subtree $SchoolRoles]
      by $ownerusers             write
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
      by [puavo_dn puavo-ticket] read
}

rule {
  [dn exact $Classes]
    [attrs entry ou objectClass]
      by $schooladmins           read
      by $ownerusers             read
      by [puavo_dn puavo-ticket] read
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
}

rule {
  [dn exact $Classes]
    [attrs children]
      by $schooladmins           write
      by $ownerusers             write
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
      by [puavo_dn puavo-ticket] read
}

rule {
  [dn subtree $Classes]
    [attrs member memberUid]
      by $org_owner              write
      by $this_school_admins     write
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
      by [puavo_dn puavo-ticket] read
}

rule {
  [dn subtree $Classes]
      by $org_owner              write
      by $this_school_admins     write
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
      by [puavo_dn puavo-ticket] read
}

rule {
  [dn subtree $Groups]
    filter=(objectClass=puavoEduGroup)
    [attrs gidNumber cn puavoId objectClass]
      by $org_owner              write
      by $this_school_admins     write
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
      by [puavo_dn puavo-ticket] read
}

rule {
  [dn subtree $Groups]
    filter=(objectClass=puavoSchool)
    [attrs gidNumber cn puavoId objectClass]
      by $ownerusers             +azrwsc
      by $schooladminusers       +rwsc
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [puavo_dn_exact puavo]  read
      by [puavo_dn puavo-ticket] read
      by [systemgroup getent]    read break
}

rule {
  [dn subtree $Groups]
    filter=(objectClass=puavoEduGroup)
      by $org_owner            write
      by $this_school_admins   write
      by [dn children $People] read
      by [dn subtree $Hosts]   read
      by [systemgroup getent]  read
}

rule {
  [dn subtree $Groups]
    filter=(objectClass=puavoSchool)
    [attrs displayName puavoNamePrefix puavoSchoolHomePageURL description \
           telephoneNumber facsimileTelephoneNumber l street postOfficeBox \
           postalAddress postalCode st jpegPhoto preferredLanguage \
           puavoLocale puavoDeviceImage puavoAllowGuest puavoPersonalDevice \
           puavoPrinterQueue puavoWirelessPrinterQueue member memberUid \
           puavoActiveService puavoDeviceAutoPowerOffMode \
           puavoAutomaticImageUpdates puavoDeviceOffHour puavoDeviceOnHour \
           puavoExternalFeed puavoMountpoint puavoTag puavoWlanChannel \
           puavoWlanSSID]
      by $schooladmins_or_ownerusers write
      by [dn children $People]       read
      by [dn subtree $Hosts]         read
      by [puavo_dn puavo-ticket]     read
      by [systemgroup getent]        read break
}

rule {
  [dn subtree $Groups]
    filter=(objectClass=puavoSchool)
      by $ownerusers             write
      by $schooladminusers       +rscxd
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
      by [puavo_dn_exact puavo]  read
      by [puavo_dn puavo-ticket] read
}

rule {
  [dn exact $Desktops]
    [attrs entry ou objectClass]
      by $schooladmins       read
      by $ownerusers         read
      by [dn subtree $Hosts] read
}

rule {
  [dn exact $Desktops]
    [attrs children]
      by [dn children $People] read
      by [dn subtree $Hosts]   read
}

rule {
  [dn exact $Files]
    [attrs entry ou objectClass]
      by $schooladmins       read
      by $ownerusers         read
      by [dn subtree $Hosts] read
}

rule {
  [dn exact $Files]
    [attrs children]
      by $schooladmins       write
      by $ownerusers         write
      by [dn subtree $Hosts] read
}

rule {
  [dn children $Files]
    by $schooladmins       write
    by $ownerusers         write
    by [dn subtree $Hosts] read
}

rule {
  [dn exact $Firefox]
    [attrs entry ou objectClass]
      by [dn children $People] read
}

rule {
  [dn exact $Firefox]
    [attrs children]
      by $schooladmins         write
      by $ownerusers           write
      by [dn children $People] read
}

rule {
  [dn children $Firefox]
    by $schooladmins         write
    by $ownerusers           write
    by [dn children $People] read
}

rule {
  [dn exact $Applications]
    [attrs entry ou objectClass]
      by [dn children $People] read
}

rule {
  [dn exact $Applications]
    [attrs children]
      by $schooladmins         write
      by $ownerusers           write
      by [dn children $People] read
}

rule {
  [dn children $Applications]
    by $schooladmins         write
    by $ownerusers           write
    by [dn children $People] read
}

rule {
  [dn exact $Bookmarks]
    [attrs entry ou objectClass]
      by [dn children $People] read
}

rule {
  [dn exact $Bookmarks]
    [attrs children]
      by $schooladmins         write
      by $ownerusers           write
      by [dn children $People] read
}

rule {
  [dn children $Bookmarks]
      by $schooladmins         write
      by $ownerusers           write
      by [dn children $People] read
}

rule {
  [dn exact $Services]
    [attrs entry ou objectClass]
      by [dn children $People] read
}

rule {
  [dn exact $Services]
    [attrs children]
      by $schooladmins         write
      by $ownerusers           write
      by [dn children $People] read
}

rule {
  [dn children $Services]
      by $schooladmins         write
      by $ownerusers           write
      by [dn children $People] read
}

rule {
  [dn exact sambaDomainName=${samba_domain}]
    [attrs sambaSID sambaDomainName sambaNextUserRid sambaNextRid]
      by [puavo_dn samba] write
      by $schooladmins    write
      by $ownerusers      write
}

rule {
  [dn exact sambaDomainName=${samba_domain}]
      by $org_owner          write
      by $this_school_admins write
      by [puavo_dn samba]    write
      by $schooladmins       read
      by $ownerusers         read
}

rule {
  [dn subtree $System_Accounts]
    [attrs userPassword]
      by $org_owner          write
      by $this_school_admins write
      by anonymous           auth
}

rule {
  [dn subtree $System_Accounts]
      by $org_owner             write
      by $this_school_admins    write
      by [puavo_dn_exact puavo] read
}

rule {
  [dn subtree $System_Groups]
    [attrs member]
      by $org_owner          write
      by $this_school_admins write
}

rule {
  [dn subtree $System_Groups]
      by $org_owner          read
      by $this_school_admins read
}

rule {
  dn="${ldapsuffix}"
    [attrs entry]
      by $schooladmins           read
      by $ownerusers             read
      by [puavo_dn_exact puavo]  read
      by [puavo_dn puavo-ticket] read
      by [puavo_dn_exact kdc]    read
      by [puavo_dn_exact kadmin] read
      by [puavo_dn puppet]       read
      by [puavo_dn monitor]      read
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
      by [systemgroup orginfo]   read
      by *                       +sxd
}

rule {
  dn="${ldapsuffix}"
    [attrs objectClass]
      by $schooladmins           read
      by $ownerusers             read
      by [puavo_dn_exact puavo]  read
      by [puavo_dn puavo-ticket] read
      by [puavo_dn_exact kdc]    read
      by [puavo_dn_exact kadmin] read
      by [puavo_dn puppet]       read
      by [puavo_dn monitor]      read
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
      by [systemgroup orginfo]   read
      by *                       +sxd
}

rule {
  dn="${ldapsuffix}"
    [attrs puavoEduOrgAbbreviation st l street postalCode postalAddress \
           telephoneNumber postOfficeBox facsimileTelephoneNumber description \
           preferredLanguage puavoLocale puavoTimezone puavoKeyboardLayout \
           puavoKeyboardVariant eduOrgLegalName o owner eduOrgHomePageURI \
           puavoWlanSSID puavoWlanChannel puavoDeviceImage puavoAllowGuest \
           puavoPersonalDevice puavoActiveService puavoDeviceOnHour \
           puavoDeviceOffHour puavoDeviceAutoPowerOffMode \
           puavoImageSeriesSourceURL puavoAutomaticImageUpdates puavoConf]
      by $ownerusers             write
      by $schooladmins           read
      by $ownerusers             read
      by [puavo_dn_exact puavo]  read
      by [puavo_dn puavo-ticket] read
      by [puavo_dn_exact kdc]    read
      by [puavo_dn_exact kadmin] read
      by [puavo_dn puppet]       read
      by [puavo_dn monitor]      read
      by [dn children $People]   read
      by [dn subtree $Hosts]     read
      by [systemgroup getent]    read
      by [systemgroup orginfo]   read
      by * +sxd
}

rule {
  dn="${ldapsuffix}"
    [attrs owner puavoDomain puavoPuppetHost]
       by $schooladmins           read
       by $ownerusers             read
       by [puavo_dn_exact puavo]  read
       by [puavo_dn puavo-ticket] read
       by [puavo_dn puppet]       read
       by [puavo_dn monitor]      read
       by [systemgroup orginfo]   read
}

rule {
  dn="${ldapsuffix}"
      by $schooladmins           read
      by $ownerusers             read
      by [puavo_dn_exact puavo]  read
      by [puavo_dn puavo-ticket] read
      by [puavo_dn_exact kdc]    read
      by [puavo_dn_exact kadmin] read
      by [puavo_dn puppet]       read
      by [puavo_dn monitor]      read
      by *                       +sxd
}

#
# print rules
#

set rulenum 0
foreach rule $rules {
  set trimmed_rule [string trim "$rule"]
  puts "{${rulenum}}to ${trimmed_rule}"
  incr rulenum
}
