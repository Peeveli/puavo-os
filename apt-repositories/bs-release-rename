#!/bin/sh

set -eu

cd /srv/aptirepo

if [ $# -ne 2 ]; then
    echo "E: invalid number of arguments ($#), expected 2" >&2
    echo "Usage: bs-release-rename OLD_VERSION NEW_VERSION" >&2
    exit 1
fi

old_version=$1
shift

new_version=$1
shift

if [ -e "${new_version}" ]; then
    echo "E: version ${new_version} already exists" >&2
    exit 1
fi

mv "${old_version}" "${new_version}"
if [ -e "${old_version}.mirror_snapshot" ]; then
    mv "${old_version}.mirror_snapshot" "${new_version}.mirror_snapshot"
fi

if [ -e versions ]; then
    awk -v "old_version=${old_version}" -v "new_version=${new_version}"         \
        '$0 == old_version {print new_version}; $0 != old_version {print $0}'   \
        versions >versions.tmp
    mv versions.tmp versions
fi

if grep -xq "${old_version}" version; then
    bs-release-set-latest "${new_version}"
fi

echo "Renamed version ${old_version} => ${new_version}"
