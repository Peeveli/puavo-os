#!/bin/sh

set -eu

if [ $# -ne 2 ]; then
    echo "E: invalid number of arguments ($#), expected 2" >&2
    echo "Usage: $0 VERSION SNAPSHOT" >&2
    exit 1
fi

version=$1
shift

snapshot=$1
shift

cd /srv/aptirepo

if [ ! -d "${version}" ]; then
    echo "E: version ${version} does not exist" >&2
    exit 1
fi

archive_url="http://archive-internal.opinsys.fi/${version}"
wget -q "${archive_url}" -O /dev/null || {
    echo "E: archive ${archive_url} does not exist" >&2
    exit 1
}

snapshot_url="http://mirror.opinsys.fi/snapshots/${snapshot}"
wget -q "${snapshot_url}" -O /dev/null || {
    echo "E: mirror snapshot ${snapshot_url} does not exist" >&2
    exit 1
}

grep -q -x "${version}" versions && {
     echo "E: version '${version}' is already published" >&2
     exit 1
}

echo "${snapshot}" >"${version}.mirror_snapshot.tmp"
mv "${version}.mirror_snapshot.tmp" "${version}.mirror_snapshot"

sed "\$a${version}" versions >versions.tmp
mv versions.tmp versions

echo "Published version ${version}"
