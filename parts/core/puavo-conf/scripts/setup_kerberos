#!/bin/sh

set -eu

read puavo_kerberos_realm < /etc/puavo/kerberos/realm

# XXX get rid of hosttype handling
if [ "$(puavo-conf puavo.hosttype)" = 'laptop' ]; then
  dns_lookup_kdc=false
  dns_lookup_realm=false

  read puavo_domain            < /etc/puavo/domain
  read puavo_kerberos_master   < /etc/puavo/kerberos/master
  read puavo_kerberos_toprealm < /etc/puavo/kerberos/toprealm
  read puavo_topdomain         < /etc/puavo/topdomain
  realms=$(cat <<EOF)
[realms]
        ${puavo_kerberos_realm} = {
                kdc = kerberos.${puavo_domain}
                kdc = ${puavo_kerberos_master}
                default_domain = ${puavo_domain}
        }
        ${puavo_kerberos_toprealm} = {
                kdc = ${puavo_kerberos_master}
                default_domain = ${puavo_topdomain}
        }
EOF
else
  dns_lookup_kdc=true
  dns_lookup_realm=true
  realms=''
fi

cat <<EOF > /etc/krb5.conf.tmp
[libdefaults]
    default_realm = ${puavo_kerberos_realm}
    default_tgs_enctypes = des3-hmac-sha1 des-cbc-crc
    default_tkt_enctypes = des3-hmac-sha1 des-cbc-crc
    dns_lookup_kdc = ${dns_lookup_kdc}
    dns_lookup_realm = ${dns_lookup_realm}
    allow_weak_crypto = true
    rdns = false   # Do not use reverse DNS queries and force use of fqdn names for everything

${realms}

[appdefaults]
        pam = {
                debug = false
                ticket_lifetime = 604800
                renew_lifetime = 604800
                forwardable = true
                krb4_convert = false
                ignore_k5login = true
        }
EOF

mv /etc/krb5.conf.tmp /etc/krb5.conf
