#!/bin/sh

set -eu

if [ "$(id -u)" -ne 0 ]; then
  echo 'You can run me as root only!' >&2
  exit 1
fi

if [ -e /run/puavo/nbd-server ]; then
  echo 'Refusing to do anything as we are on an NBD root' >&2
  exit 1
fi

puavo_hosttype=$(cat /etc/puavo/hosttype)

if [ "$puavo_hosttype" != "laptop" ]; then
  echo "I do not know how to wipe hosts of type '${puavo_hosttype}'" >&2
  exit 1
fi

while true; do
  cat <<'EOF'
DANGER, WILL ROBINSON!  DANGER!

THIS PROCEDURE WILL DESTROY ALL YOUR DATA IN YOUR HOME DIRECTORY!

This utility tries to quickly reset laptop state to something as if
it came from "the factory", as if nobody had ever used it.  This will
DESTROY YOUR STUFF and home directory contents, though in a quick way so
that old files MAY still recoverable with suitable tools.  If possible,
you should consider erasing things in a more secure way by doing a
reinstall with a full disk device "wipe".  That option is not perfect
either, but much better than this quick-and-dirty procedure.

DANGER!
THIS PROCEDURE WILL DESTROY ALL YOUR DATA IN YOUR HOME DIRECTORY, AND MORE!
WHEN IN DOUBT, TURN OFF THE MACHINE, PANIC AND RUN AWAY!
EOF
  echo
  read -p 'Are you sure you want to continue? (yes/no) ' answer
  case "$answer" in
    yes)
      echo 'THIS WILL DESTROY EVERYTHING!!!  WHAT ARE YOU THINKING?!?!?'
      read -p 'Are you REALLY sure? (yes/no) ' second_answer
      if [ "$second_answer" = "yes" ]; then
        break
      fi
      ;;
    no)
      echo 'Okay then, maybe a wise choice!'
      exit 0
      ;;
    *)
      echo "I do not understand that.\n" >&2
      ;;
  esac
done

cd /

# Remove primary user (so that we will send this information
# to Puavo through update-configuration).
cat /dev/null > /state/etc/puavo/primary_user_override

{
  echo starting...
  find /images/puavo-pkg/ -mindepth 1 -print0 | xargs -0 rm -vrf
  echo done.
} 2>&1 | sed 's|^|>>>>> Removing all puavo-pkgs - |'

{
  echo starting...
  find /home/ -mindepth 1 -print0 | xargs -0 rm -vrf
  echo done.
} 2>&1 | sed 's|^|>>>>> Cleaning up /home - |'

{
  echo starting...
  find /state/etc/puavo/local/ -mindepth 1 -print0 | xargs -0 rm -vrf
  echo done.
} 2>&1 | sed 's|^|>>>>> Removing local configurations (made by user) - |'

{
  echo starting...
  find /state/var/cache/ -mindepth 1 -print0 | xargs -0 rm -vrf
  echo done.
} 2>&1 | sed 's|^|>>>>> Cleaning up caches - |'

{
  echo starting...
  find /state/var/lib/ -mindepth 1 -print0 | xargs -0 rm -vrf
  echo done.
} 2>&1 | sed 's|^|>>>>> Removing some system configurations - |'

{
  echo starting...
  /usr/lib/puavo-ltsp-install/update-configuration || true
  echo done.
} 2>&1 | sed 's|^|>>>>> Updating system configuration - |'

{
  echo starting...
  find /imageoverlays/ -mindepth 1 -print0 | xargs -0 rm -vrf
  echo done.
} 2>&1 | sed 's|^|>>>>> Cleaning up /imageoverlays - |'

# do this last because it might break the network connection
{
  echo starting...
  find /state/etc/NetworkManager/system-connections/ -mindepth 1 -print0 \
    | xargs -0 rm -vrf
  echo done.
} 2>&1 | sed 's|^|>>>>> Removing network manager connections - |'

i=5
echo -n "rebooting in $i seconds..."
while [ "$i" -gt 0 ]; do
  i=$(($i - 1))
  sleep 1
  echo -n " $i"
done
echo .

reboot
