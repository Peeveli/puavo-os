#!/bin/sh

set -eu

# XXX cleanup should be done in case this is interrupted

imagefile=${1:-}
images_dir=/installimages
puavoimage_name=$(cat /etc/puavo-image/name)

calc_required_imagefile_gigabytes() {
  echo "$(($(df --block-size=1G --output=size /rofs | awk 'NR == 2') + 2))"
}

install_image() {
  # There should be no need to run the preinst-hook, because for now it
  # it only contains the grub update.  Because the installed image and the
  # current boot image are same, the grub configuration should be correct.
  puavo-install-and-update-ltspimages --hosttype diskinstaller   \
                                      --images-dir "$images_dir" \
                                      --no-preinst-hook          \
                                      "$@"                       \
                                      "$puavoimage_name"
}

if [ -e /run/puavo/nbd-server ]; then
  install_args='--install-from-nbd /dev/nbd0'
else
  install_args="--install-from-file /images/${puavoimage_name}"
fi

loopdev=''
if [ -n "$imagefile" ]; then
  if [ -e "$imagefile" ]; then
    echo "target file $imagefile exists, not overwriting" >&2
    exit 1
  fi

  dd if=/dev/null "of=${imagefile}" bs=1M \
     seek="$(calc_required_imagefile_gigabytes)K"
  loopdev=$(losetup --show -f "$imagefile")

  puavo-setup-filesystems --accept-defaults \
                          --default-confirm-partitions yes \
                          --default-disk-device "${loopdev#/dev/}" \
                          --hosttype diskinstaller \
                          --loopback-only
else
  puavo-setup-filesystems --hosttype diskinstaller
fi

puavo-install-grub --hosttype   diskinstaller  \
                   --images-dir "$images_dir"  \
                   --vgname     puavoinstaller

install_image $install_args

umount "$images_dir"
dmsetup remove puavoinstaller-installimages

# do not leak file descriptors to vgchange, hence "3>&- 4>&- 5>&-"
vgchange -a n puavoinstaller 3>&- 4>&- 5>&-

rmdir /installimages

if [ -n "$loopdev" ]; then
  losetup -d "$loopdev"
fi
