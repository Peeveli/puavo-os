#!/usr/bin/ruby

require 'json'
require 'puavo/conf'
require 'shellwords'
require 'syslog'

puavoconf = Puavo::Conf.new
puavo_xrandr_args = puavoconf.get('puavo.xrandr.args')
puavoconf.close

xrandr_args_list = JSON.parse(puavo_xrandr_args)

raise 'puavo.xrandr.args not in correct format' \
  unless xrandr_args_list.kind_of?(Array)

status = 0

Syslog.open(File.basename($0), Syslog::LOG_CONS)

xrandr_args_list.each do |xrandr_args_string|
  xrandr_args = Shellwords.shellwords(xrandr_args_string)
  system('xrandr', *xrandr_args)
  system_status = $?.exitstatus

  if system_status != 0 then
    Syslog.log(Syslog::LOG_ERR,
               "xrandr FAILED with arguments %s",
               xrandr_args.join(' '))
    status = system_status
  else
    Syslog.log(Syslog::LOG_INFO,
               "xrandr ok with arguments %s",
               xrandr_args.join(' '))
  end
end

Syslog.close()

exit(status)
