#!/bin/bash

set -eu

darkdm_systeminfo()
{
  blockdevice_sda_size=$(facter blockdevice_sda_size \
    | awk '$1 ~ /^[0-9]+$/ { printf "%.0f GB\n", $1 / 1000000000 }')
  this_image=$(cat /etc/puavo-image/name)
  this_release=$(cat /etc/puavo-image/release)

  cat <<EOF
image:   ${this_image}
release: ${this_release}

bios:            $(facter bios_vendor) / $(facter bios_version)
blockdevice sda: $(facter blockdevice_sda_model) / ${blockdevice_sda_size}
cpu:             $(facter processorcount) CPUs / $(facter processor0)
memory:          $(facter memorysize)
network:         IP $(facter ipaddress) / MAC $(facter macaddress)
product:         $(facter manufacturer) / $(facter productname)
serial numbers:  $(facter serialnumber) (machine) / $(facter boardserialnumber) (board)
some pci devices:
$(lspci | awk '$2 == "Network" || $2 == "VGA"' | sed 's/^/  /')
EOF
}

darkdm_reboot()
{
    local i

    for i in $(seq 5 -1 1); do
        echo -n -e "\rRebooting in ${i}s. (Press Ctrl-C to cancel)"
        sleep 1 || return 1
    done
    echo -e "\rRebooting now!                              "

    reboot
}

darkdm_install()
{
    if ! /usr/sbin/puavo-install "$@"; then
      # give some time for users to read the error message, if there is any
      echo
      sleep 4
      return 1
    fi

    darkdm_reboot
}

darkdm_print_help()
{
    cat <<'EOF'

Puavo OS Command Shell

Commands:
  build                - build Puavo OS image and poweroff
  install              - install Puavo OS to this device and reboot
  kbd [layout]         - set keyboard layout
  live                 - switch to graphical mode
  make-install-disk    - make a bootable usb flash drive or some such
  nmtui                - configure network (not available on netboot devices)
  poweroff             - poweroff the system in 5 seconds
  preinstall           - install without registering
  preseed-install (pi) - install with a preseed
  preseed-preinstall   - install without registering but with a preseed
  reboot               - reboot the system in 5 seconds
  restoredisk          - restore from bootserver (only on netboot devices)
  savedisk             - save to bootserver (only on netboot devices)
  shell                - spawn a shell
  update               - update the local Puavo OS installation and reboot
EOF
}

darkdm_shell()
{
    /bin/bash
}

darkdm_update()
{
    local image_name update_status

    update_status=0

    if image_name=$(cat /etc/puavo-image/name 2>/dev/null); then
      /usr/sbin/puavo-install-and-update-ltspimages \
	--install-from-nbd /dev/nbd0 "$image_name" || update_status=1
    else
      update_status=1
    fi

    if ! /usr/lib/puavo-ltsp-install/update-configuration >/dev/null 2>&1; then
      echo 'Configuration update FAILED!' >&2
      update_status=1
    else
      echo 'Configuration update OK.'
    fi

    if [ "$update_status" -ne 0 ]; then
      return "$update_status"
    fi

    darkdm_reboot
}

darkdm_poweroff()
{
    local i

    for i in $(seq 5 -1 1); do
        echo -n -e "\rPowering-off in ${i}s. (Press Ctrl-C to cancel)"
        sleep 1 || return 1
    done
    echo -e "\rPowering-off now!                              "

    poweroff
}

darkdm_build()
{
    /usr/lib/puavo-ltsp-client/handle-image-build-request || return 1

    darkdm_poweroff
}

darkdm_kbd() {
    new_layout=$1

    current_layout=$(localectl status \
                       | awk '/X11 Layout:/ { split($3, a, ","); print a[1] }')

    if [ -z "$new_layout" ]; then
        possible_layouts="$(localectl list-x11-keymap-layouts | xargs \
                              | fmt -w 70 | sed 's/^/  /')"

        cat <<EOF
Current keyboard layout is: $current_layout
Choose from layouts:
$possible_layouts
EOF
        read -p 'Choose keyboard layout: ' new_layout
    fi

    if [ -z "$new_layout" ]; then
        echo 'Not changing keyboard layout'
    elif localectl set-keymap "$new_layout"; then
        echo "Changed keyboard layout to \"${new_layout}\""
    else
        echo "Could not change keyboard layout" >&2
    fi

    setupcon

    sleep 0.5
    echo
}

darkdm_live() {
    echo -n 'switching to graphical mode'
    # needed due to some bug in Buster:
    service accounts-daemon start || true
    echo -n .; sleep 1
    echo -n .; sleep 1
    echo -n .; sleep 1

    # switch to GUI mode (should stop puavo-darkdm as a side effect)
    systemctl isolate graphical.target
}

darkdm_menu()
{
    local command
    local initial_command
    local prompt

    initial_command=$1
    shift

    while true; do
	echo "$systeminfo"
	darkdm_print_help

        if [ -n "$initial_command" ]; then
            prompt="[${initial_command}]> "
        else
            prompt='> '
        fi

	read -e -p "$prompt" command command_args || return 1

	if [ -z "$command" -a -n "$initial_command" ]; then
	    command="$initial_command"
	fi

	case "${command}" in
	    build)
		darkdm_build
		;;
	    install)
		darkdm_install
		;;
	    kbd)
		darkdm_kbd "$command_args"
		;;
	    live)
		darkdm_live
		;;
	    make-install-disk)
		puavo-make-install-disk
		;;
	    nmtui)
		if [ ! -x /usr/bin/nmtui ]; then
		    echo 'nmtui not available' >&2
		else
		    nmtui || true
		fi
		;;
	    poweroff)
		darkdm_poweroff
		;;
            preinstall)
		darkdm_install preinstall
		;;
            preseed-preinstall)
		darkdm_install preseed-preinstall
		;;
            preseed-install|pi)
		darkdm_install preseed-install
		;;
	    reboot)
		darkdm_reboot
		;;
	    restoredisk)
                puavo-disk-clone restoredisk
		;;
	    savedisk)
                puavo-disk-clone savedisk
		;;
	    shell)
		darkdm_shell
		;;
	    update)
		darkdm_update
		;;
	    *)
		echo "Error: Invalid command '${command}'." >&2
		;;
	esac
    done
}

darkdm_main()
{
    local hosttype
    local initial_command

    hosttype=$(cat /etc/puavo/hosttype)
    case "${hosttype}" in
	laptop|wirelessaccesspoint)
	    initial_command='update'
	    ;;
	unregistered)
	    initial_command='install'
	    ;;
	*)
	    initial_command=
	    ;;
    esac

    darkdm_menu "${initial_command}"
}

echo 'Gathering system information...'
echo
systeminfo=$(darkdm_systeminfo 2>/dev/null || true)

while true; do
    if darkdm_main; then
	echo 'Operation was a success.'
    else
	echo "Operation failed with error code $?."
    fi

    echo 'Press ENTER to continue.'
    read _
done
