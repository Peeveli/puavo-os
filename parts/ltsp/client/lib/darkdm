#!/bin/bash

set -eu

darkdm_reboot()
{
    local i

    for i in $(seq 5 -1 1); do
        echo -n -e "\rRebooting in ${i}s. (Press Ctrl-C to cancel)"
        sleep 1 || return 1
    done
    echo -e "\rRebooting now!                              "

    reboot
}

darkdm_install()
{
    /usr/sbin/puavo-install || return 1

    darkdm_reboot
}

darkdm_print_help()
{
    echo "Puavo OS Command Shell"
    echo
    echo "Commands:"
    echo "  build    -  build Puavo OS image and poweroff"
    echo "  help     -  show this help"
    echo "  install  -  install Puavo OS to this device and reboot"
    echo "  poweroff -  poweroff the system in 5 seconds"
    echo "  reboot   -  reboot the system in 5 seconds"
    echo "  shell    -  spawn a shell"
    echo "  update   -  update the local Puavo OS installation and reboot"
}

darkdm_shell()
{
    /bin/bash
}

darkdm_update()
{
    local image_name

    image_name=$(cat /etc/puavo-image/name) || return 1

    /usr/sbin/puavo-install-and-update-ltspimages \
	--install-from-nbd /dev/nbd0 "${image_name}" || return 1

    darkdm_reboot
}

darkdm_poweroff()
{
    local i

    for i in $(seq 5 -1 1); do
        echo -n -e "\rPowering-off in ${i}s. (Press Ctrl-C to cancel)"
        sleep 1 || return 1
    done
    echo -e "\rPowering-off now!                              "

    poweroff
}

darkdm_build()
{
    /usr/lib/puavo-ltsp-client/handle-image-build-request || return 1

    darkdm_poweroff
}

darkdm_menu()
{
    local initial_command
    local command

    initial_command=$1
    shift

    while true; do
	if [ -n "${initial_command}" ]; then
	    echo "> ${initial_command}"
	    command="${initial_command}"
	    initial_command=
	else
	    read -e -p "> " command
	fi

	case "${command}" in
	    'build')
		darkdm_build
		;;
	    'help')
		darkdm_print_help
		;;
            'install')
		darkdm_install
		;;
	    'poweroff')
		darkdm_poweroff
		;;
	    'reboot')
		darkdm_reboot
		;;
	    'shell')
		darkdm_shell
		;;
	    'update')
		darkdm_update
		;;
	    *)
		echo "Error: Invalid command '${command}'. Try 'help'." >&2
		;;
	esac
    done
}

darkdm_main()
{
    local hosttype
    local initial_command
    local tty_arg
    local tty_dev
    local tty_n

    tty_arg=${1:-}

    if [ -n "$tty_arg" ]; then
	tty_n=$tty_arg
    else
        tty_dev=$(tty)
        tty_n=$(echo "${tty_dev}" | sed -r -n 's|/dev/tty||p')
    fi

    if [ -n "${tty_n}" ]; then
	chvt "${tty_n}" || return 1
    fi

    export LANG=en_US.UTF-8
    setupcon

    # suppress most kernel messages from this terminal
    dmesg -n2

    darkdm_print_help

    hosttype=$(cat /etc/puavo/hosttype)
    case "${hosttype}" in
	unregistered)
	    initial_command='install'
	    ;;
	*)
	    initial_command=
	    ;;
    esac

    darkdm_menu "${initial_command}"
}

darkdm_main "$@"
