#!/bin/sh

set -eu

command=$1
shift

mimio_binaries='
  mimio-collaborate
  mimio-gallery
  mimio-gradebook
  mimio-install
  mimio-launch
  mimio-markup
  mimio-mimiosys
  mimio-notebook
  mimio-quickvote
  mimio-restart
  mimio-reveal
  mimio-spotlight
  mimio-texttools
  mimio-tools
  mimio-view
'

mimio_links='
  /etc/modprobe.d/blacklist-mimio.conf
  /etc/xdg/autostart/mimio-mimiosys.desktop
  /etc/xdg/menus/applications-merged/mimio.menu
  /lib/udev/rules.d/60-mimio-projector.rules
  /lib/udev/rules.d/60-mimio.rules
  /lib/udev/rules.d/60-mimio-tablet.rules
  /usr/share/applications/mimio-collaborate.desktop
  /usr/share/applications/mimio-gallery.desktop
  /usr/share/applications/mimio-gradebook.desktop
  /usr/share/applications/mimio-launch.desktop
  /usr/share/applications/mimio-notebook.desktop
  /usr/share/applications/mimio-quickvote.desktop
  /usr/share/applications/mimio-reveal.desktop
  /usr/share/applications/mimio-spotlight.desktop
  /usr/share/applications/mimio-texttools.desktop
  /usr/share/applications/mimio-tools.desktop
  /usr/share/applications/mimio-view.desktop
  /usr/share/desktop-directories/mimio-studio.directory
  /usr/share/desktop-directories/mimio-studio-tools.directory
  /usr/share/icons/application-x-mimio-gallery.png
  /usr/share/icons/application-x-mimio-gradebook.png
  /usr/share/icons/application-x-mimio-notebook.png
  /usr/share/icons/mimio-collaborate.png
  /usr/share/icons/mimio-gallery.png
  /usr/share/icons/mimio-gradebook.png
  /usr/share/icons/mimio-install.png
  /usr/share/icons/mimio-launch.png
  /usr/share/icons/mimio-markup.png
  /usr/share/icons/mimio-merlotapp.png
  /usr/share/icons/mimio-notebook.png
  /usr/share/icons/mimio-quickvote.png
  /usr/share/icons/mimio-restart.png
  /usr/share/icons/mimio-reveal.png
  /usr/share/icons/mimio-spotlight.png
  /usr/share/icons/mimio-texttools.png
  /usr/share/icons/mimio-tools.png
  /usr/share/icons/mimio-view.png
  /usr/share/mime/packages/mimio.xml
  /var/opt/mimio
'

configure_system_links() {
  csl_upstream_dir=$1

  for f in $mimio_links; do
    dir=$(dirname "${f}")
    mkdir -p "${dir}"
    ln -fns -T "${csl_upstream_dir}${f}" "${f}"
  done
}

setup_binary_wrappers() {
  sbw_upstream_dir=$1

  for mimio_bin in $mimio_binaries; do
    mv "${sbw_upstream_dir}/${mimio_bin}" \
       "${sbw_upstream_dir}/${mimio_bin}.orig"
    cat <<-EOF > "${sbw_upstream_dir}/${mimio_bin}"
	#!/bin/sh

	exec env LD_LIBRARY_PATH=/opt/trusty/lib/i386-linux-gnu \
             "${sbw_upstream_dir}/${mimio_bin}.orig" "$@"
	EOF
    chmod 755 "${sbw_upstream_dir}/${mimio_bin}"
  done
}

case "${command}" in
  configure)
    upstream_dir=$1
    configure_system_links "$upstream_dir"
    ;;

  unconfigure)
    rm -rf $mimio_links
    ;;

  unpack)
    upstream_pack=$1
    upstream_dir=$2

    dpkg -x "$upstream_pack" "$upstream_dir"

    configure_system_links "$upstream_dir"

    rm -f /var/opt/mimio/.install-complete

    env LD_LIBRARY_PATH=/opt/trusty/lib/i386-linux-gnu \
        /var/opt/mimio/mimio-mimiosys \
        /var/opt/mimio/tmp/app_mimiostudio.mcd

    waiting_for_mimio=0
    while [ ! -e /var/opt/mimio/.install-complete \
            -a "$waiting_for_mimio" -lt 300 ]; do
      sleep 1
      waiting_for_mimio=$(($waiting_for_mimio + 1))
    done
    if [ "$waiting_for_mimio" -eq 900 ]; then
      echo 'Failed to wait for mimio' >&2
      exit 1
    fi

    setup_binary_wrappers "$upstream_dir"

    # these installer files take about 640MB
    # and we do not need them after the installation
    rm -rf ${upstream_dir}/var/opt/mimio/tmp/*.mcd \
           ${upstream_dir}/var/opt/mimio/tmp/*.pkg

    # normally unpacking should not configure the software so remove the
    # configuration links
    rm -rf $mimio_links
    ;;
esac
