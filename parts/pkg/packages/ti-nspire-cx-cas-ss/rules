#!/bin/sh

set -eu

command=$1
shift

tisoftdir=/opt/wine/ti-nspire-cx-cas-ss

install_additional_components() {
  cat <<'EOF' > "${tisoftdir}/ti-nspire-cx-cas-ss"
#!/bin/sh

set -eu

program_exe_dir='drive_c/Program Files/TI Education/TI-Nspire CX CAS Student Software'
program_exe_name='TI-Nspire CX CAS Student Software.exe'
tisoftdir=/opt/wine/ti-nspire-cx-cas-ss

WINEARCH=win32
WINEPREFIX=~/.wineprefix-ti-nspire-cx-cas

export WINEARCH WINEDLLOVERRIDES WINEPREFIX

app_version=4.5.0.1180+opinsys1

run_setup() {
  # Setup $WINEPREFIX for user

  app_data_dir='drive_c/users/Public/Application Data/TI-Nspire CX CAS'

  rm -rf "${WINEPREFIX}/${program_exe_dir}"

  rsync -a \
        --exclude "$program_exe_dir" \
        --exclude 'drive_c/users/%%PUAVOUSER%%' \
        --exclude "${app_data_dir}" \
        "${tisoftdir}/wineprefix/" \
        "${WINEPREFIX}/"
  rsync -a "${tisoftdir}/wineprefix/drive_c/users/%%PUAVOUSER%%/" \
        "${WINEPREFIX}/drive_c/users/${USER}/"
  ln -fns "${tisoftdir}/wineprefix/${program_exe_dir}" \
          "${WINEPREFIX}/${program_exe_dir}"

  for filename in system.reg userdef.reg user.reg; do
    awk -v user="$USER" '{ gsub("%%PUAVOUSER%%", user); print }' \
      "${tisoftdir}/wineprefix/${filename}" > "${WINEPREFIX}/${filename}"
  done

  if [ ! -e "${WINEPREFIX}/${app_data_dir}" ]; then
    rsync -a "${tisoftdir}/wineprefix/${app_data_dir}/" \
          "${WINEPREFIX}/${app_data_dir}/"
    sed 's/^allow.auto.upgrade=/allow.auto.upgrade=False/;
         s/^allow.analytics=/allow.analytics=False/' \
      "${tisoftdir}/wineprefix/${app_data_dir}/res/settings.properties" \
      > "${WINEPREFIX}/${app_data_dir}/res/settings.properties"
  fi

  # mimetype associations
  mkdir -p ~/.local/share/applications
  cat <<-EOF > ~/.local/share/applications/wine-extension-tns.desktop
	[Desktop Entry]
	Type=Application
	Name=TI-Nspire CX CAS Student Software
	MimeType=application/x-wine-extension-tns;
	Exec=env WINEPREFIX="${WINEPREFIX}" wine-stable start /ProgIDOpen TI-NspireCXCAS-SS.Document %f
	NoDisplay=true
	StartupNotify=true
	Icon=E542_TI-Nspire CX CAS Student Software.0
	EOF
  cat <<-EOF > ~/.local/share/applications/wine-extension-tnsp.desktop
	[Desktop Entry]
	Type=Application
	Name=TI-Nspire CX CAS Student Software
	MimeType=application/x-wine-extension-tnsp;
	Exec=env WINEPREFIX="${WINEPREFIX}" wine-stable start /ProgIDOpen TI-NspireCXCAS-SS-tnsp.Document %f
	NoDisplay=true
	StartupNotify=true
	Icon=E542_TI-Nspire CX CAS Student Software.0
	EOF

  mkdir -p ~/.local/share/mime/application
  cat <<-EOF > ~/.local/share/mime/application/x-wine-extension-tns.xml
	<?xml version="1.0" encoding="utf-8"?>
	<mime-type xmlns="http://www.freedesktop.org/standards/shared-mime-info" type="application/x-wine-extension-tns">
	  <!--Created automatically by update-mime-database. DO NOT EDIT!-->
	  <glob pattern="*.tns"/>
	  <comment>TI-Nspire CX CAS Student Software Document</comment>
	</mime-type>
	EOF
  cat <<-EOF > ~/.local/share/mime/application/x-wine-extension-tnsp.xml
	<?xml version="1.0" encoding="utf-8"?>
	<mime-type xmlns="http://www.freedesktop.org/standards/shared-mime-info" type="application/x-wine-extension-tnsp">
	  <!--Created automatically by update-mime-database. DO NOT EDIT!-->
	  <glob pattern="*.tnsp"/>
	  <comment>TI-Nspire CX CAS Student Software Document</comment>
	</mime-type>
	EOF

  mkdir -p ~/.local/share/mime/packages
  cat <<-EOF > ~/.local/share/mime/packages/x-wine-extension-tns.xml
	<?xml version="1.0" encoding="UTF-8"?>
	<mime-info xmlns="http://www.freedesktop.org/standards/shared-mime-info">
	  <mime-type type="application/x-wine-extension-tns">
	    <glob pattern="*.tns"/>
	    <comment>TI-Nspire CX CAS Student Software Document</comment>
	  </mime-type>
	</mime-info>
	EOF
  cat <<-EOF > ~/.local/share/mime/packages/x-wine-extension-tnsp.xml
	<?xml version="1.0" encoding="UTF-8"?>
	<mime-info xmlns="http://www.freedesktop.org/standards/shared-mime-info">
	  <mime-type type="application/x-wine-extension-tnsp">
	    <glob pattern="*.tnsp"/>
	    <comment>TI-Nspire CX CAS Student Software Document</comment>
	  </mime-type>
	</mime-info>
	EOF

  xdg-mime default wine-extension-tns.desktop \
      application/x-wine-extension-tns
  xdg-mime default wine-extension-tnsp.desktop \
      application/x-wine-extension-tnsp
}

# The previous version did not use the .setup_version scheme.
if [ -e "${WINEPREFIX}/.setup_done.1" ]; then
  rm -f "${WINEPREFIX}/.setup_done.1"
  echo 4.3.0.702 > "${WINEPREFIX}/.setup_version"
fi

installed_version="$(cat "${WINEPREFIX}/.setup_version" 2>/dev/null || true)"
if [ "$app_version" != "$installed_version" ]; then
  run_setup
  echo "$app_version" > "${WINEPREFIX}/.setup_version"
fi

cd "${WINEPREFIX}/${program_exe_dir}"
wine "$program_exe_name"
EOF
  chmod 755 "${tisoftdir}/ti-nspire-cx-cas-ss"

  cat <<'EOF' > /usr/local/share/applications/ti_nspire_cx_cas_ss.desktop
[Desktop Entry]
Name=TI-Nspire CX CAS Student Software
Description=TI-Nspire CX CAS Student Software
Exec=/opt/wine/ti-nspire-cx-cas-ss/ti-nspire-cx-cas-ss
Type=Application
StartupNotify=true
Terminal=false
Icon=/opt/wine/ti-nspire-cx-cas-ss/ti_nspire_cx_cas_ss.png
Categories=Education;
EOF

  base64 -d <<'EOF' > "${tisoftdir}/ti_nspire_cx_cas_ss.png"
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
AAAAAElFTkSuQmCC
EOF
}

case "$command" in
  configure)
    upstream_dir=$1

    # If ti_nspire_cx_cas_ss license is not enabled, do not configure
    # a package.
    if [ "$(puavo-conf puavo.nonfree.ti_nspire_cx_cas_ss.enabled)" != 'true' ]; then
      exit 0
    fi

    mkdir -p "$tisoftdir"
    ln -fns "${upstream_dir}/ti-nspire-cx-cas-ss-4.5.0.1180-wineprefix" \
            "${tisoftdir}/wineprefix"
    install_additional_components
    ;;

  unconfigure)
    rm -rf "$tisoftdir" \
           /usr/local/share/applications/ti_nspire_cx_cas_ss.desktop
    ;;

  unpack)
    upstream_pack=$1
    upstream_dir=$2

    tar --no-same-owner -z -x -f "${upstream_pack}" -C "${upstream_dir}"
    ;;

  *)
    ;;
esac
