#!/bin/sh

# detect development mode
if [ -f package.json ]; then
    export PATH="$(pwd)/bin:$PATH"
fi

. webmenu-env

# set webmenu window type to be menu
# (actually running this once for each webmenu startup should be enough)
webmenu_xwin_id=$(xdotool search --name Webmenu)
if [ -n "$webmenu_xwin_id" ]; then
  xprop -id "$webmenu_xwin_id" -f _NET_WM_WINDOW_TYPE 32a \
    -set _NET_WM_WINDOW_TYPE _NET_WM_WINDOW_TYPE_MENU
fi

default_spawn_sock=~/.config/webmenu/spawn.sock

args="$@"
status=0

spawn(){
    echo "$args" | nc -U $1
    status=$?
}

spawn $WM_SOCK

# Retry with default pipe path. Used when starting webmenu with "nw ."
if [ "$status" != "0"  ]; then
    spawn $default_spawn_sock
fi

if [ "$status" != "0"  ]; then
    echo "fail"
    notify-send --urgency=critical "Failed to spawn Webmenu" "Not running?"
fi
